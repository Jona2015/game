<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Slither Ultimate</title>
<style>
/* --- Grundlayout --- */
body {
  margin:0;
  overflow:hidden;
  background:#111;
  font-family:Arial, sans-serif;
  color:white;
}
canvas { display:block; }
#menu {
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#222e;
  padding:20px;
  border-radius:12px;
  text-align:center;
  width:280px;
}
select,input,button { width:90%; margin:6px; padding:6px; }
#leaderboard {
  position:fixed;
  left:10px; top:10px;
  background:#000a;
  padding:10px;
  border-radius:8px;
}
#minimap {
  position:fixed;
  right:10px; top:10px;
  width:180px; height:180px;
  background:#000a;
  border:2px solid #555;
}
#joystick {
  position:fixed;
  bottom:40px; left:40px;
  width:120px; height:120px;
  border-radius:50%;
  background:#0008;
  touch-action:none;
}
#stick {
  position:absolute;
  left:40px; top:40px;
  width:40px; height:40px;
  border-radius:50%;
  background:#0f0;
}
</style>
</head>
<body>

<!-- --- Startmen√º --- -->
<div id="menu">
<h2>SLITHER</h2>
<input id="playerName" value="Player" placeholder="Name">
<select id="skin">
  <option value="solid">Solid</option>
  <option value="stripes">Streifen</option>
  <option value="dots">Punkte</option>
</select>
<button onclick="startGame()">START</button>
</div>

<!-- --- Leaderboard + Minimap --- -->
<div id="leaderboard"></div>
<canvas id="game"></canvas>
<canvas id="minimap"></canvas>

<!-- --- Joystick f√ºr Mobile --- -->
<div id="joystick"><div id="stick"></div></div>

<script>
// ====================
// --- Setup Canvas ---
// ====================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const mini = document.getElementById("minimap");
const mctx = mini.getContext("2d");
canvas.width = innerWidth; canvas.height = innerHeight;
mini.width = mini.height = 180;

const WORLD_SIZE = 8000;
let zoom = 0.35, running = false;
let camera = {x:0, y:0};
let mouse = {x:0, y:0};
let joystick = {x:0, y:0, active:false};
addEventListener("mousemove", e => { mouse.x = e.clientX; mouse.y = e.clientY; });

// ====================
// --- Utils ---
// ====================
const rand = (a,b)=>Math.random()*(b-a)+a;
const dist = (a,b)=>Math.hypot(a.x-b.x, a.y-b.y);

// ====================
// --- Game Variables ---
// ====================
const foods = [];
const particles = [];
const bots = [];
let player;

// ====================
// --- Snake Class ---
// ====================
class Snake {
  constructor(x,y,color,isBot=false){
    this.segments = [{x,y}];
    this.len = 30;
    this.width = 6;
    this.speed = 4;
    this.angle = 0;
    this.color = color;
    this.dead = false;
    this.isBot = isBot;
    this.name = isBot ? "Bot" + (rand(1,999)|0) : "";
    this.skin = "solid";
    this.boost = false;
  }

  update(target){
    if(this.dead) return;
    let sp = this.speed;
    if(this.boost && this.len > 15){
      sp *= 2.3;
      this.len -= 0.2;
      const t = this.segments[this.segments.length-1];
      foods.push({x:t.x, y:t.y}); // Boost hinterl√§sst Food-Spur
    }
    if(target) this.angle = Math.atan2(target.y - this.segments[0].y, target.x - this.segments[0].x);
    const h = this.segments[0];
    this.segments.unshift({x:h.x + Math.cos(this.angle)*sp, y:h.y + Math.sin(this.angle)*sp});
    while(this.segments.length > this.len) this.segments.pop();
  }

  draw(){
    for(let i=0; i<this.segments.length; i++){
      if(this.skin==="stripes" && i%2) continue;
      if(this.skin==="dots" && i%3) continue;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.segments[i].x, this.segments[i].y, this.width,0,Math.PI*2);
      ctx.fill();
    }
  }
}

// ====================
// --- Explosions ---
// ====================
function explode(x,y,color){
  for(let i=0;i<50;i++) particles.push({
    x,y,vx:rand(-4,4),vy:rand(-4,4),life:40,color
  });
}

// ====================
// --- Start Game ---
// ====================
function startGame(){
  document.getElementById("menu").style.display="none";
  running = true;
  player = new Snake(0,0,"lime");
  player.name = document.getElementById("playerName").value || "Player";
  player.skin = document.getElementById("skin").value;

  bots.length = 0;
  for(let i=0;i<40;i++){
    let b = new Snake(rand(-WORLD_SIZE,WORLD_SIZE), rand(-WORLD_SIZE,WORLD_SIZE),"red",true);
    b.len = rand(40,160);
    b.skin = ["solid","stripes","dots"][Math.random()*3|0];
    bots.push(b);
  }

  foods.length = 0;
  for(let i=0;i<30000;i++) foods.push({x:rand(-WORLD_SIZE,WORLD_SIZE), y:rand(-WORLD_SIZE,WORLD_SIZE)});
}

// ====================
// --- Input ---
// ====================
addEventListener("keydown", e => { if(e.code==="Space") player.boost = true; });
addEventListener("keyup", e => { if(e.code==="Space") player.boost = false; });

const stick = document.getElementById("stick");
const joyArea = document.getElementById("joystick");

joyArea.addEventListener("touchstart", e => joystick.active = true);
joyArea.addEventListener("touchend", e => { joystick.active=false; joystick.x=joystick.y=0; stick.style.left="40px"; stick.style.top="40px"; });
joyArea.addEventListener("touchmove", e => {
  const r = 40;
  const t = e.touches[0];
  const rect = joyArea.getBoundingClientRect();
  let x = t.clientX - rect.left - 60;
  let y = t.clientY - rect.top - 60;
  const d = Math.hypot(x,y);
  if(d>r){x*=r/d;y*=r/d;}
  joystick.x = x/r; joystick.y = y/r;
  stick.style.left = 40+x+"px"; stick.style.top = 40+y+"px";
});

// ====================
// --- Game Loop ---
// ====================
function loop(){
  if(!running) return;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  camera.x += (player.segments[0].x - camera.x)*0.1;
  camera.y += (player.segments[0].y - camera.y)*0.1;

  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.scale(zoom, zoom);
  ctx.translate(-camera.x, -camera.y);

  // --- Food ---
  ctx.fillStyle="orange";
  foods.forEach((f,i)=>{
    ctx.beginPath(); ctx.arc(f.x,f.y,4,0,Math.PI*2); ctx.fill();
    if(dist(player.segments[0],f)<10){ player.len+=1; player.width+=0.01; foods.splice(i,1);}
  });

  // --- Player movement ---
  let tx,ty;
  if(joystick.active){
    tx = player.segments[0].x + joystick.x*200;
    ty = player.segments[0].y + joystick.y*200;
  } else {
    tx = camera.x + (mouse.x - canvas.width/2)/zoom;
    ty = camera.y + (mouse.y - canvas.height/2)/zoom;
  }
  player.update({x:tx, y:ty});

  // --- Bot AI ---
  bots.forEach(b=>{
    let d = dist(b.segments[0], player.segments[0]);
    let t = d<700 ? {x:player.segments[0].x+Math.cos(b.angle+1.5)*300, y:player.segments[0].y+Math.sin(b.angle+1.5)*300} 
                   : foods[Math.floor(Math.random()*foods.length)];
    b.boost = d<400;
    b.update(t);
  });

  // --- Collision Logic ---
  bots.forEach(b=>{
    if(b.dead) return;
    // Bot-Kopf trifft Spieler-K√∂rper ‚Üí Bot stirbt
    for(let i=15;i<player.segments.length;i++){
      if(dist(b.segments[0], player.segments[i])<b.width){
        explode(b.segments[0].x, b.segments[0].y, "red");
        b.dead = true;
        b.segments.forEach(s=>foods.push({x:s.x,y:s.y}));
      }
    }
    // Spieler-Kopf trifft Bot-K√∂rper ‚Üí Spieler stirbt
    for(let i=15;i<b.segments.length;i++){
      if(dist(player.segments[0], b.segments[i])<player.width){
        explode(player.segments[0].x, player.segments[0].y, "lime");
        location.reload();
      }
    }
  });

  // --- Particles ---
  particles.forEach((p,i)=>{
    p.x+=p.vx; p.y+=p.vy; p.life--;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x,p.y,2,2);
    if(p.life<=0) particles.splice(i,1);
  });

  // --- Draw Snakes ---
  player.draw();
  bots.forEach(b=>!b.dead && b.draw());

  // --- Leaderboard ---
  const lb = [player,...bots.filter(b=>!b.dead)]
              .sort((a,b)=>b.len-b.len).slice(0,5);
  document.getElementById("leaderboard").innerHTML = "<b>üåê Online</b><br>" +
    lb.map(s=>`${s.name}: ${Math.floor(s.len)}`).join("<br>");

  // --- Minimap ---
  mctx.clearRect(0,0,180,180);
  const sc = 180/(WORLD_SIZE*2);
  mctx.fillStyle = "lime";
  mctx.fillRect(90+player.segments[0].x*sc,90+player.segments[0].y*sc,3,3);
  bots.forEach(b=>{
    mctx.fillStyle = "red";
    mctx.fillRect(90+b.segments[0].x*sc, 90+b.segments[0].y*sc,3,3);
  });

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
